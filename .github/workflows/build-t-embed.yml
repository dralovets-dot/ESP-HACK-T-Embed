name: Build T-Embed Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
      
    - name: Install PlatformIO
      run: |
        pip install --upgrade platformio
        pio platform update
        pio platform install espressif32
      
    - name: Configure TFT_eSPI for T-Embed
      run: |
        # Создаем временную конфигурацию для T-Embed
        mkdir -p lib/TFT_eSPI_fix
        cat > lib/TFT_eSPI_fix/User_Setup.h << 'TFT_CONFIG'
        // Lilygo T-Embed configuration
        #define USER_SETUP_INFO "Lilygo T-Embed"
        
        // Display pins
        #define TFT_CS   5
        #define TFT_DC   15
        #define TFT_RST  -1
        #define TFT_BL   38
        
        // Display settings
        #define TFT_WIDTH   170
        #define TFT_HEIGHT  320
        #define TFT_ROTATION 1
        
        // SPI settings
        #define TFT_SPI_PORT 1
        #define SPI_FREQUENCY  40000000
        #define SPI_READ_FREQUENCY  20000000
        
        // Features
        #define SUPPORT_TRANSACTIONS
        #define LOAD_GLCD
        TFT_CONFIG
        
        echo "TFT_eSPI configured for T-Embed"
      
    - name: Build with PlatformIO
      run: |
        echo "=== Building firmware for T-Embed ==="
        
        # Показываем конфигурацию
        echo "PlatformIO version:"
        pio --version
        
        echo "Platforms:"
        pio platform list
        
        echo "Libraries:"
        pio lib list 2>/dev/null || true
        
        # Пробуем собрать
        echo "=== Starting build ==="
        pio run || echo "Build failed with default settings"
        
        # Проверяем результаты
        echo "=== Build artifacts ==="
        find .pio -name "*.bin" -o -name "*.elf" 2>/dev/null | xargs ls -la 2>/dev/null || echo "No binaries found"
      
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: firmware-binaries
        path: |
          .pio/build/**/*.bin
          .pio/build/**/*.elf
        retention-days: 7
      
    - name: Build report
      if: always()
      run: |
        echo "=== Build Report ==="
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Date: $(date)"
        
        if find .pio -name "*.bin" 2>/dev/null | grep -q .; then
          echo "✅ BUILD SUCCESSFUL"
          BIN_FILE=$(find .pio -name "*.bin" | head -1)
          echo "Firmware: $BIN_FILE"
          echo "Size: $(wc -c < "$BIN_FILE") bytes"
        else
          echo "❌ BUILD FAILED"
          echo "Check logs above for errors"
        fi
